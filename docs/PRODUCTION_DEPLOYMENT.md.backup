# Production Deployment Guide

**DropLab Marketing Platform** - Complete production deployment instructions

**Last Updated**: Phase 5 - Environment Configuration Documentation
**Supported Platforms**: Vercel, Railway, Render, Netlify, AWS, DigitalOcean
**Deployment Time**: 15-30 minutes (first time)

---

## Table of Contents

1. [Pre-Deployment Checklist](#pre-deployment-checklist)
2. [Vercel Deployment (Recommended)](#vercel-deployment-recommended)
3. [Railway Deployment](#railway-deployment)
4. [Render Deployment](#render-deployment)
5. [Self-Hosted (AWS/DigitalOcean)](#self-hosted-deployment)
6. [Database Setup](#database-setup)
7. [Third-Party Services](#third-party-services)
8. [Environment Variables](#environment-variables)
9. [Post-Deployment](#post-deployment)
10. [Monitoring & Maintenance](#monitoring--maintenance)
11. [Troubleshooting](#troubleshooting)

---

## Pre-Deployment Checklist

Before deploying, ensure you have:

### 1. Required Accounts

- [ ] GitHub account (for code repository)
- [ ] Supabase account (for production database)
- [ ] OpenAI account with API key
- [ ] Stripe account (for billing)
- [ ] Hosting platform account (Vercel/Railway/Render)

### 2. Required API Keys

- [ ] OpenAI API key (`OPENAI_API_KEY`)
- [ ] Supabase credentials (URL, anon key, service role key)
- [ ] Stripe keys (secret, publishable, price ID, webhook secret)

### 3. Optional Services (Recommended)

- [ ] PostGrid account (direct mail printing)
- [ ] Resend account (transactional emails)
- [ ] Data Axle account (audience targeting) - Optional, uses mock data if missing
- [ ] ElevenLabs account (voice AI) - Optional

### 4. Code Preparation

```bash
# Ensure clean build
npm run build

# Verify no TypeScript errors
npx tsc --noEmit

# Run tests
npm test

# Commit all changes
git add .
git commit -m "Prepare for production deployment"
git push origin main
```

---

## Vercel Deployment (Recommended)

**Why Vercel?**
- ✅ Official Next.js hosting platform
- ✅ Zero-config deployment
- ✅ Automatic HTTPS & CDN
- ✅ Edge functions support
- ✅ Free tier: 100GB bandwidth, unlimited requests

### Step 1: Connect Repository

1. Visit [vercel.com](https://vercel.com/)
2. Click "Add New Project"
3. Import your GitHub repository
4. Select the repository (e.g., `droplab-platform`)

### Step 2: Configure Project

**Framework Preset**: Next.js (auto-detected)

**Build Settings**:
```
Build Command: npm run build
Output Directory: .next
Install Command: npm install
```

**Root Directory**: `.` (leave default)

### Step 3: Environment Variables

Click "Environment Variables" and add:

#### Core Variables (Required)
```
OPENAI_API_KEY=sk-proj-...
NEXT_PUBLIC_APP_URL=https://your-project.vercel.app
DATABASE_TYPE=supabase
NEXT_PUBLIC_SUPABASE_URL=https://yourproject.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...
```

#### Billing (Required for subscriptions)
```
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_PRICE_ID=price_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

#### Optional Services
```
POSTGRID_API_KEY_LIVE=live_sk_...
RESEND_API_KEY=re_...
DATA_AXLE_API_KEY=your-api-key
ELEVENLABS_API_KEY=c6c78a2b...
```

#### Infrastructure (Recommended)
```
NEXT_PUBLIC_ERROR_TRACKING_ENABLED=true
NEXT_PUBLIC_ERROR_LOG_CONSOLE=false
NEXT_PUBLIC_ERROR_SAMPLE_RATE=0.1
NEXT_PUBLIC_LOGGING_ENABLED=true
NEXT_PUBLIC_LOG_LEVEL=ERROR
NEXT_PUBLIC_RATE_LIMITING_ENABLED=true
NEXT_PUBLIC_RATE_LIMIT_MAX_REQUESTS=100
```

**Environment**: Select "Production" for all variables

### Step 4: Deploy

1. Click "Deploy"
2. Wait 2-3 minutes for build
3. Vercel will provide deployment URL: `https://your-project.vercel.app`

### Step 5: Custom Domain (Optional)

1. Go to Project Settings → Domains
2. Add your custom domain (e.g., `app.droplab.io`)
3. Follow DNS configuration instructions
4. Update `NEXT_PUBLIC_APP_URL` to your custom domain
5. Redeploy

### Step 6: Configure Webhooks

**Stripe Webhooks**:
1. Stripe Dashboard → Developers → Webhooks
2. Add endpoint: `https://your-project.vercel.app/api/stripe/webhook`
3. Select events: `invoice.payment_succeeded`, `customer.subscription.*`
4. Copy webhook secret
5. Update `STRIPE_WEBHOOK_SECRET` in Vercel environment variables
6. Redeploy

**PostGrid Webhooks** (if using):
1. PostGrid Dashboard → Webhooks
2. Add endpoint: `https://your-project.vercel.app/api/webhooks/postgrid`
3. Update `POSTGRID_WEBHOOK_SECRET`

**ElevenLabs Webhooks** (if using):
1. ElevenLabs Dashboard → Webhooks
2. Add endpoint: `https://your-project.vercel.app/api/webhooks/elevenlabs`
3. Update `ELEVENLABS_WEBHOOK_SECRET`

---

## Railway Deployment

**Why Railway?**
- ✅ Easy PostgreSQL + Redis hosting
- ✅ Automatic previews for PRs
- ✅ Built-in monitoring
- ✅ Free tier: $5 credit/month

### Step 1: Create New Project

1. Visit [railway.app](https://railway.app/)
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Authorize GitHub and select repository

### Step 2: Configure Service

**Service Name**: droplab-platform

**Build Settings**:
```
Build Command: npm run build
Start Command: npm start
```

**Port**: Railway auto-detects port from Next.js (3000)

### Step 3: Add PostgreSQL (Optional)

1. Click "New" → "Database" → "Add PostgreSQL"
2. Railway provisions database automatically
3. Connection string available in `DATABASE_URL` variable

**Note**: Use Supabase for production (better for SaaS). Railway PostgreSQL is good for simple deployments.

### Step 4: Add Redis (Optional)

1. Click "New" → "Database" → "Add Redis"
2. Railway provisions Redis automatically
3. Connection details available in environment variables

### Step 5: Environment Variables

Click "Variables" tab and add all required variables (same as Vercel section above).

**Railway-Specific**:
```
# If using Railway PostgreSQL instead of Supabase
DATABASE_URL=${{Postgres.DATABASE_URL}}  # Auto-injected

# If using Railway Redis
REDIS_HOST=${{Redis.REDIS_HOST}}
REDIS_PORT=${{Redis.REDIS_PORT}}
REDIS_PASSWORD=${{Redis.REDIS_PASSWORD}}
```

### Step 6: Deploy

1. Railway auto-deploys on push to main branch
2. Deployment URL: `https://droplab-platform.railway.app`
3. Configure custom domain in Settings → Domains

---

## Render Deployment

**Why Render?**
- ✅ Free tier with automatic HTTPS
- ✅ Good for full-stack apps
- ✅ Managed PostgreSQL available

### Step 1: Create Web Service

1. Visit [render.com](https://render.com/)
2. Click "New" → "Web Service"
3. Connect GitHub repository

### Step 2: Configure Service

**Name**: droplab-platform

**Environment**: Node

**Build Command**: `npm install && npm run build`

**Start Command**: `npm start`

**Plan**: Free or Starter ($7/month for always-on)

### Step 3: Environment Variables

Add all environment variables from Vercel section.

**Render-Specific**:
- Render provides `RENDER` environment variable automatically
- Use `https://your-app.onrender.com` for `NEXT_PUBLIC_APP_URL`

### Step 4: Deploy

1. Click "Create Web Service"
2. First deploy takes 5-10 minutes
3. Subsequent deploys: 2-3 minutes

---

## Self-Hosted Deployment

For AWS, DigitalOcean, or custom VPS.

### Option 1: Docker Deployment

**Create `Dockerfile`**:
```dockerfile
FROM node:18-alpine AS base

# Install dependencies only when needed
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

COPY package*.json ./
RUN npm ci

# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Copy environment variables
ARG OPENAI_API_KEY
ARG NEXT_PUBLIC_APP_URL
# ... add all other ENV vars as ARG

# Build application
RUN npm run build

# Production image
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000

CMD ["node", "server.js"]
```

**Build & Run**:
```bash
# Build image
docker build -t droplab-platform .

# Run container
docker run -p 3000:3000 \
  -e OPENAI_API_KEY=sk-proj-... \
  -e NEXT_PUBLIC_APP_URL=https://yourdomain.com \
  -e DATABASE_TYPE=supabase \
  -e NEXT_PUBLIC_SUPABASE_URL=https://yourproject.supabase.co \
  -e NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci... \
  -e SUPABASE_SERVICE_ROLE_KEY=eyJhbGci... \
  droplab-platform
```

### Option 2: PM2 Deployment

**Install PM2**:
```bash
npm install -g pm2
```

**Create `ecosystem.config.js`**:
```javascript
module.exports = {
  apps: [{
    name: 'droplab-platform',
    script: 'npm',
    args: 'start',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000,
    },
  }],
};
```

**Deploy**:
```bash
# Build application
npm run build

# Start with PM2
pm2 start ecosystem.config.js

# Save PM2 configuration
pm2 save

# Setup PM2 startup script
pm2 startup
```

### Option 3: Nginx Reverse Proxy

**Install Nginx**:
```bash
sudo apt update
sudo apt install nginx
```

**Create Nginx config** (`/etc/nginx/sites-available/droplab`):
```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**Enable site**:
```bash
sudo ln -s /etc/nginx/sites-available/droplab /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

**Install SSL with Certbot**:
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com
```

---

## Database Setup

### Supabase (Recommended for Production)

1. Visit [supabase.com](https://supabase.com/)
2. Create new project
3. Wait 2-3 minutes for provisioning
4. Go to Settings → API
5. Copy:
   - Project URL → `NEXT_PUBLIC_SUPABASE_URL`
   - anon/public key → `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - service_role key → `SUPABASE_SERVICE_ROLE_KEY`

6. Run migrations:
   ```bash
   npx supabase db push
   ```

7. Enable Row Level Security (RLS):
   - Go to Authentication → Policies
   - Enable RLS on all tables
   - Policies are auto-configured via migrations

### PostgreSQL (Self-Hosted)

If using your own PostgreSQL:

```bash
# Install PostgreSQL
sudo apt install postgresql postgresql-contrib

# Create database
sudo -u postgres createdb droplab

# Create user
sudo -u postgres createuser --interactive

# Set password
sudo -u postgres psql
ALTER USER droplab WITH PASSWORD 'your-password';
GRANT ALL PRIVILEGES ON DATABASE droplab TO droplab;
\q
```

**Connection String**:
```
DATABASE_URL=postgresql://droplab:your-password@localhost:5432/droplab
```

---

## Third-Party Services

### 1. Stripe Setup

**Test Mode** (Development):
1. Dashboard → Developers → API Keys
2. Copy test keys (pk_test_, sk_test_)
3. Create test product:
   - Dashboard → Products → Add Product
   - Name: "DropLab Pro - Monthly"
   - Price: $499/month
   - Copy Price ID (price_test_...)

**Live Mode** (Production):
1. Complete Stripe onboarding
2. Activate account
3. Switch to Live mode
4. Copy live keys (pk_live_, sk_live_)
5. Create live product (same as test)

**Webhooks**:
1. Dashboard → Developers → Webhooks
2. Add endpoint: `https://yourdomain.com/api/stripe/webhook`
3. Events: `invoice.payment_succeeded`, `customer.subscription.*`
4. Copy signing secret → `STRIPE_WEBHOOK_SECRET`

### 2. PostGrid Setup

1. Visit [postgrid.com](https://postgrid.com/)
2. Create account
3. Developers → API Keys
4. Copy test key → `POSTGRID_API_KEY_TEST`
5. For production:
   - Complete onboarding
   - Add payment method
   - Copy live key → `POSTGRID_API_KEY_LIVE`

### 3. Resend Setup

1. Visit [resend.com](https://resend.com/)
2. Sign up (free tier: 100 emails/day)
3. Dashboard → API Keys → Create
4. Copy key → `RESEND_API_KEY`

**Domain Verification** (Production):
1. Dashboard → Domains → Add Domain
2. Add your domain (e.g., updates.droplab.app)
3. Add DNS records:
   ```
   Type: TXT
   Name: _resend
   Value: (provided by Resend)
   ```
4. Verify domain
5. Update email "from" address in code

### 4. Data Axle Setup (Optional)

1. Visit [data-axle.com](https://www.data-axle.com/)
2. Contact sales for API access
3. Plans start at $79/month
4. Copy API key → `DATA_AXLE_API_KEY`

**Note**: If omitted, system uses mock data automatically.

---

## Environment Variables

**Quick Copy-Paste for Production**:

```bash
# ==================== CORE ====================
OPENAI_API_KEY=sk-proj-...
NEXT_PUBLIC_APP_URL=https://yourdomain.com
DATABASE_TYPE=supabase

# ==================== SUPABASE ====================
NEXT_PUBLIC_SUPABASE_URL=https://yourproject.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...

# ==================== STRIPE ====================
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_PRICE_ID=price_...
STRIPE_WEBHOOK_SECRET=whsec_...

# ==================== OPTIONAL SERVICES ====================
POSTGRID_API_KEY_LIVE=live_sk_...
POSTGRID_WEBHOOK_SECRET=whsec_...
RESEND_API_KEY=re_...
DATA_AXLE_API_KEY=your-api-key
ELEVENLABS_API_KEY=c6c78a2b...
ELEVENLABS_WEBHOOK_SECRET=wsec_...

# ==================== INFRASTRUCTURE ====================
# Error Tracking (Phase 2)
NEXT_PUBLIC_ERROR_TRACKING_ENABLED=true
NEXT_PUBLIC_ERROR_LOG_CONSOLE=false
NEXT_PUBLIC_ERROR_SAMPLE_RATE=0.1

# Logging (Phase 3)
NEXT_PUBLIC_LOGGING_ENABLED=true
NEXT_PUBLIC_LOG_LEVEL=ERROR
NEXT_PUBLIC_LOG_CONTEXT=false

# Rate Limiting (Phase 4)
NEXT_PUBLIC_RATE_LIMITING_ENABLED=true
NEXT_PUBLIC_RATE_LIMIT_MAX_REQUESTS=100
NEXT_PUBLIC_RATE_LIMIT_WINDOW_MS=60000

# ==================== OTHER ====================
IMAGE_GEN_VERSION=v2
USE_PERSISTENT_RENDERING=true
```

**See**: `docs/ENVIRONMENT_VARIABLES.md` for complete reference.

---

## Post-Deployment

### 1. Verify Deployment

**Check Homepage**:
```bash
curl https://yourdomain.com
# Should return 200 OK
```

**Check API Routes**:
```bash
curl https://yourdomain.com/api/health
# Should return { "status": "ok" }
```

**Check Database Connection**:
1. Sign up for account
2. Verify user created in Supabase dashboard
3. Check auth.users table

### 2. Test Critical Paths

- [ ] User sign up
- [ ] User login
- [ ] Campaign creation
- [ ] Landing page generation
- [ ] Stripe checkout (test mode)
- [ ] Webhook delivery (Stripe, PostGrid)

### 3. Monitor Logs

**Vercel**:
- Project → Deployments → Click deployment → Runtime Logs

**Railway**:
- Service → Deployments → Click deployment → Logs

**Render**:
- Service → Logs tab

**Self-hosted**:
```bash
# PM2 logs
pm2 logs droplab-platform

# Docker logs
docker logs <container-id>
```

### 4. Set Up Monitoring

**Vercel Analytics** (Free):
1. Project → Analytics tab
2. Automatically tracks:
   - Page views
   - Unique visitors
   - Performance metrics

**Sentry** (Optional, for errors):
1. Visit [sentry.io](https://sentry.io/)
2. Create project
3. Install SDK:
   ```bash
   npm install @sentry/nextjs
   npx @sentry/wizard -i nextjs
   ```
4. Configure error tracking in Phase 2 system

**Uptime Monitoring** (Recommended):
- [UptimeRobot](https://uptimerobot.com/) - Free, 50 monitors
- [Pingdom](https://www.pingdom.com/) - Paid, advanced features
- [BetterUptime](https://betteruptime.com/) - Free tier available

### 5. Set Up Backups

**Supabase Backups**:
- Automatic daily backups (Pro plan)
- Manual backups: Dashboard → Database → Backups

**File Storage Backups**:
- Use Supabase Storage for user uploads
- Configure bucket policies
- Enable automatic backups

---

## Monitoring & Maintenance

### Daily Checks

- [ ] Check error logs for critical errors
- [ ] Monitor API usage (OpenAI, Stripe)
- [ ] Check uptime status

### Weekly Checks

- [ ] Review error rates (Phase 2 error tracking)
- [ ] Check rate limit hits (Phase 4)
- [ ] Monitor database size (Supabase dashboard)
- [ ] Review user sign-ups and subscriptions

### Monthly Checks

- [ ] Review API costs (OpenAI, Stripe, PostGrid)
- [ ] Check for dependency updates:
   ```bash
   npm outdated
   ```
- [ ] Review security advisories:
   ```bash
   npm audit
   ```
- [ ] Test critical user paths
- [ ] Review backup integrity

### Quarterly Checks

- [ ] Rotate Supabase service role key
- [ ] Review and rotate webhook secrets
- [ ] Performance audit
- [ ] Security audit
- [ ] Update documentation

---

## Troubleshooting

### Issue: "Internal Server Error" after deployment

**Diagnosis**:
```bash
# Check logs
vercel logs <deployment-url>

# Or
railway logs
```

**Common Causes**:
1. Missing environment variables
2. Database connection error
3. Build error

**Solutions**:
1. Verify all required env vars are set
2. Check `NEXT_PUBLIC_SUPABASE_URL` is correct
3. Rebuild deployment

### Issue: Webhooks not working

**Diagnosis**:
```bash
# Test webhook endpoint
curl -X POST https://yourdomain.com/api/stripe/webhook \
  -H "Content-Type: application/json" \
  -d '{"type": "test"}'
```

**Common Causes**:
1. Incorrect webhook URL
2. Missing webhook secret
3. Firewall blocking

**Solutions**:
1. Verify webhook URL in Stripe dashboard
2. Update `STRIPE_WEBHOOK_SECRET`
3. Check Vercel/Railway firewall settings

### Issue: Database queries failing

**Diagnosis**:
- Check Supabase logs: Dashboard → Logs
- Verify RLS policies: Dashboard → Authentication → Policies

**Common Causes**:
1. RLS blocking queries
2. Incorrect service role key
3. Network connectivity

**Solutions**:
1. Disable RLS temporarily to test
2. Verify `SUPABASE_SERVICE_ROLE_KEY` is correct
3. Check Supabase status page

### Issue: High API costs

**Diagnosis**:
- Check OpenAI usage: [platform.openai.com/usage](https://platform.openai.com/usage)
- Review logs for excessive API calls

**Solutions**:
1. Enable rate limiting (Phase 4):
   ```bash
   NEXT_PUBLIC_RATE_LIMITING_ENABLED=true
   NEXT_PUBLIC_RATE_LIMIT_MAX_REQUESTS=100
   ```
2. Implement caching for AI responses
3. Use lower-cost models (gpt-4o-mini vs gpt-4)

### Issue: Slow response times

**Diagnosis**:
- Check Vercel Analytics → Performance
- Review database query performance in Supabase

**Solutions**:
1. Enable database indexes
2. Optimize slow queries
3. Implement caching (Redis)
4. Use Edge functions for static content

---

## Rollback Procedure

If deployment fails or introduces bugs:

### Vercel Rollback

1. Project → Deployments
2. Find previous working deployment
3. Click "..." → "Promote to Production"
4. Instant rollback (< 1 minute)

### Railway Rollback

1. Service → Deployments
2. Find previous working deployment
3. Click "Redeploy"

### Git Rollback

```bash
# Find commit to rollback to
git log

# Revert to specific commit
git revert <commit-hash>

# Or hard reset (destructive)
git reset --hard <commit-hash>
git push --force
```

---

## Additional Resources

- **Environment Variables Reference**: `docs/ENVIRONMENT_VARIABLES.md`
- **Error Tracking Documentation**: `PHASE_2_COMPLETE.md`
- **Logging Documentation**: `PHASE_3_COMPLETE.md`
- **Rate Limiting Documentation**: `PHASE_4_COMPLETE.md`
- **Next.js Deployment Docs**: [nextjs.org/docs/deployment](https://nextjs.org/docs/deployment)
- **Supabase Docs**: [supabase.com/docs](https://supabase.com/docs)
- **Vercel Docs**: [vercel.com/docs](https://vercel.com/docs)

---

**Last Updated**: Phase 5 - Environment Configuration Documentation
**Maintained By**: DropLab Development Team
**Support**: For deployment issues, see troubleshooting section above
